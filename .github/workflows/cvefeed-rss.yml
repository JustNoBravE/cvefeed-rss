name: CVE Monitor

on:
  push:
    branches: [ main ]
  schedule:
    # 每15分钟运行一次
    - cron: '*/15 * * * *'

jobs:
  run-monitor:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install feedparser schedule

    - name: Configure email
      run: |
        # 从GitHub Secrets中获取邮件配置
        cat > email_config.json << EOF
        {
            "smtp_server": "${{ secrets.SMTP_SERVER }}",
            "smtp_port": ${{ secrets.SMTP_PORT }},
            "use_tls": true,
            "username": "${{ secrets.EMAIL_USERNAME }}",
            "password": "${{ secrets.EMAIL_PASSWORD }}",
            "from": "${{ secrets.EMAIL_FROM }}",
            "to": ["${{ secrets.EMAIL_TO }}"]
        }
        EOF

    - name: Run CVE Monitor
      run: python cve_rss_monitor.py --email-config email_config.json

    - name: Commit and push data
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git add data/
        git add log/
        git commit -m 'Update reports and logs'
        git push
      continue-on-error: true
